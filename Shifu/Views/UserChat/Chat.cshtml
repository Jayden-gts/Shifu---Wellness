@model List<Shifu.Models.UserData>
@{
    Layout = "_Layout";
}
<input id="currentUserId" type="hidden" value="@User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value" />

<div class="container mt-4">
    <h3>Pick a Mentor</h3>
    <div class="row">
        <div class="col-4">
            <ul class="list-group">
                @foreach (var m in Model)
                {
                    <li class="list-group-item">
                        <h5>@m.FirstName @m.LastName</h5>
                        <p>@m.Qualifications</p>
                        <p><strong>Specialties:</strong> @m.Specialities</p>
                        <p>@m.Bio</p>
                        <button class="btn btn-sm btn-primary assignBtn" data-id="@m.Id">Select Mentor</button>
                        <a class="btn btn-sm btn-outline-secondary ms-2" asp-controller="UserChat" asp-action="Chat">Open Chat</a>
                    </li>
                }
            </ul>
        </div>

        <div class="col-8">
            <h4>Chat</h4>
            <div id="messages" class="border p-3 mb-2" style="height:350px; overflow-y:auto;"></div>
            <textarea id="messageInput" class="form-control mb-2"></textarea>
            <button id="sendBtn" class="btn btn-primary">Send</button>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.5/signalr.min.js"></script>
<script>
    const currentUserId = document.getElementById("currentUserId").value;
    let selectedMentorId = 0;

    // fetch assigned mentor from server
    fetch(`/UserChat/GetAssignedMentor?userId=${currentUserId}`)
        .then(res => res.json())
        .then(data => {
            if(data.mentorId) {
                selectedMentorId = data.mentorId;
                loadMessages();
            }
        });

    function loadMessages() {
        fetch(`/UserChat/LoadMessages?userId=${currentUserId}&mentorId=${selectedMentorId}`)
            .then(res => res.json())
            .then(data => {
                const msgs = document.getElementById("messages");
                msgs.innerHTML = "";
                data.forEach(m => msgs.innerHTML += `<div><b>${m.sentByMentor ? "Mentor" : "You"}:</b> ${m.content}</div>`);
            });
    }
    
    // Assign mentor button
    document.querySelectorAll(".assignBtn").forEach(b => b.addEventListener("click", async () => {
        selectedMentorId = b.dataset.id;
        const res = await fetch('/UserChat/AssignMentor?mentorId=' + selectedMentorId, { method: 'POST' });
        if (res.ok) alert('Mentor assigned. Chat loaded.');
        
        // Reload messages after assignment
        fetch(`/UserChat/LoadMessages?userId=${currentUserId}&mentorId=${selectedMentorId}`)
            .then(res => res.json())
            .then(data => {
                const msgs = document.getElementById("messages");
                msgs.innerHTML = "";
                data.forEach(m => msgs.innerHTML += `<div><b>${m.sentByMentor ? "Mentor" : "You"}:</b> ${m.content}</div>`);
            });
    }));

    // Send message button
    document.getElementById("sendBtn").addEventListener("click", async () => {
        const content = document.getElementById("messageInput").value;
        if (!content.trim()) return;
        if (!selectedMentorId) { alert("Select a mentor first"); return; }

        await fetch(`/UserChat/SendMessages?mentorId=${selectedMentorId}&message=${encodeURIComponent(content)}`, { method: 'POST' });
        const msgs = document.getElementById("messages");
        msgs.innerHTML += `<div><b>You:</b> ${content}</div>`;
        document.getElementById("messageInput").value = "";
    });
</script>
